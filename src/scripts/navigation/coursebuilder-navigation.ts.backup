/**
 * Course Builder Navigation
 * Handles navigation between main sections: setup, create, preview, launch
 */

import { AsideNavigation } from './aside';

export class CourseBuilderNavigation {
  private currentSection: string = 'setup';
  private sections: NodeListOf<HTMLElement>;
  private nextButton: HTMLElement | null;
  private previousButton: HTMLElement | null;
  private asideNavigation: AsideNavigation;

  constructor() {
    this.sections = document.querySelectorAll('.section');
    this.nextButton = document.getElementById('next-btn');
    this.previousButton = document.getElementById('previous-btn');
    
    // Initialize aside navigation for setup section
    this.asideNavigation = new AsideNavigation();
    
    this.initialize();
  }

  private initialize(): void {
    this.setupEventListeners();
    this.initializeFromHash();
    this.updateButtons();
  }

  private setupEventListeners(): void {
    // Listen for hash changes
    window.addEventListener('hashchange', () => {
      this.handleHashChange();
    });

    // Next button functionality
    if (this.nextButton) {
      this.nextButton.addEventListener('click', () => {
        this.navigateNext();
      });
    }

    // Previous button functionality
    if (this.previousButton) {
      this.previousButton.addEventListener('click', () => {
        this.navigatePrevious();
      });
    }
  }

  private initializeFromHash(): void {
    const hash = window.location.hash.substring(1); // Remove #
    console.log('üß≠ Initializing from hash:', hash);
    
    if (hash && this.isValidSection(hash)) {
      this.currentSection = hash;
      console.log('üß≠ Valid hash detected, setting current section to:', hash);
    } else {
      this.currentSection = 'setup'; // Default section
      console.log('üß≠ No valid hash, defaulting to setup');
      // Only update URL if there's no hash at all
      if (!hash) {
        history.replaceState(null, '', '#setup');
      }
    }
    this.activateSection(this.currentSection);
  }

  private handleHashChange(): void {
    const hash = window.location.hash.substring(1);
    if (hash && this.isValidSection(hash)) {
      this.currentSection = hash;
      this.activateSection(this.currentSection);
      this.updateButtons();
    }
  }

  private isValidSection(section: string): boolean {
    const validSections = ['setup', 'create', 'preview', 'launch'];
    return validSections.includes(section);
  }

  private activateSection(sectionId: string): void {
    console.log(`üß≠ Activating section: ${sectionId}`);
    
    // Hide all sections
    this.sections.forEach(section => {
      section.classList.remove('section--active');
      
      // Also deactivate all articles in all sections
      const articles = section.querySelectorAll('.article');
      articles.forEach(article => {
        article.classList.remove('article--active');
      });
    });

    // Show the target section
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
      targetSection.classList.add('section--active');
      
      // For sections that don't use aside navigation (like create, preview, launch),
      // activate the main article automatically
      if (sectionId !== 'setup') {
        const mainArticle = targetSection.querySelector('.article');
        if (mainArticle) {
          mainArticle.classList.add('article--active');
          console.log(`üß≠ Article activated for section: ${sectionId}`);
        }
      }
      
      console.log(`üéØ Successfully navigated to section: ${sectionId}`);
    } else {
      console.error(`‚ùå Section not found: ${sectionId}`);
    }
  }

  private navigateNext(): void {
    const sectionOrder = ['setup', 'create', 'preview', 'launch'];
    const currentIndex = sectionOrder.indexOf(this.currentSection);
    
    if (currentIndex < sectionOrder.length - 1) {
      const nextSection = sectionOrder[currentIndex + 1];
      this.navigateToSection(nextSection);
    }
  }

  private navigatePrevious(): void {
    const sectionOrder = ['setup', 'create', 'preview', 'launch'];
    const currentIndex = sectionOrder.indexOf(this.currentSection);
    
    if (currentIndex > 0) {
      const prevSection = sectionOrder[currentIndex - 1];
      this.navigateToSection(prevSection);
    } else {
      // If we're at the first section, go back to courses page
      window.location.href = '/src/pages/teacher/courses.html';
    }
  }

  private navigateToSection(sectionId: string): void {
    if (this.isValidSection(sectionId)) {
      window.location.hash = sectionId;
    }
  }

  private updateButtons(): void {
    const sectionOrder = ['setup', 'create', 'preview', 'launch'];
    const currentIndex = sectionOrder.indexOf(this.currentSection);

    // Update next button
    if (this.nextButton) {
      if (currentIndex < sectionOrder.length - 1) {
        this.nextButton.style.display = 'block';
        const nextSection = sectionOrder[currentIndex + 1];
        this.nextButton.textContent = this.getSectionDisplayName(nextSection);
      } else {
        this.nextButton.textContent = 'Finish';
        // Could add functionality to save/publish course
      }
    }

    // Update previous button
    if (this.previousButton) {
      if (currentIndex > 0) {
        const prevSection = sectionOrder[currentIndex - 1];
        this.previousButton.textContent = this.getSectionDisplayName(prevSection);
      } else {
        this.previousButton.textContent = 'Courses';
      }
    }
  }

  private getSectionDisplayName(sectionId: string): string {
    const displayNames: Record<string, string> = {
      'setup': 'Setup',
      'create': 'Create',
      'preview': 'Preview',
      'launch': 'Launch'
    };
    return displayNames[sectionId] || sectionId;
  }

  /**
   * Public method to get current section
   */
  public getCurrentSection(): string {
    return this.currentSection;
  }

  /**
   * Public method to navigate to a specific section
   */
  public goToSection(sectionId: string): void {
    this.navigateToSection(sectionId);
  }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  // Only initialize on coursebuilder page
  const navElement = document.querySelector('.nav--coursebuilder');
  console.log('üß≠ DOM loaded, looking for .nav--coursebuilder:', !!navElement);
  
  if (navElement) {
    console.log('üß≠ Initializing CourseBuilder Navigation...');
    new CourseBuilderNavigation();
    console.log('üß≠ Course Builder Navigation initialized');
  } else {
    console.log('üß≠ Not on coursebuilder page - navigation not initialized');
  }
});

// FALLBACK: Force hash navigation to work immediately if navigation fails
window.addEventListener('load', () => {
  if (window.location.pathname.includes('coursebuilder.html')) {
    const hash = window.location.hash.substring(1);
    if (hash && ['setup', 'create', 'preview', 'launch'].includes(hash)) {
      console.log('üß≠ FALLBACK: Forcing hash navigation to:', hash);
      
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('section--active');
        section.querySelectorAll('.article').forEach(article => {
          article.classList.remove('article--active');
        });
      });
      
      // Show target section
      const targetSection = document.getElementById(hash);
      if (targetSection) {
        targetSection.classList.add('section--active');
        
        if (hash !== 'setup') {
          const mainArticle = targetSection.querySelector('.article');
          if (mainArticle) {
            mainArticle.classList.add('article--active');
          }
        }
        
        console.log('üß≠ FALLBACK: Successfully forced navigation to:', hash);
      }
    }
  }
});
