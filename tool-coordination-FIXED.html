<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Tool Coordination Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            padding: 10px 15px;
            margin: 5px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .button:hover {
            background: #005a99;
        }
        .button.active {
            background: #28a745;
        }
        .drawing-tools [data-tool].active {
            background: #28a745;
        }
        .perspective-tools [data-perspective].active,
        .perspective-tools .perspective__item--active {
            background: #dc3545;
            color: white;
        }
        .status {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #007acc;
            margin-top: 15px;
            font-family: monospace;
        }
        .tools-section {
            display: inline-block;
            margin: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .tools-section h3 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>üéØ FIXED Tool Coordination System Test</h1>
    <p><strong>Key Fix:</strong> Canvas drawing events are now completely disabled when grab tool is active!</p>
    
    <div class="test-container">
        <h2>Interactive Tool Test</h2>
        <p><strong>Expected Behavior:</strong></p>
        <ul>
            <li>Selecting any drawing tool should deactivate grab tool</li>
            <li>Selecting grab tool should deactivate drawing tools <strong>AND disable canvas events</strong></li>
            <li>Only one tool should be visually active at a time</li>
            <li><strong>Canvas events status shows ENABLED/DISABLED</strong></li>
        </ul>
        
        <div class="tools-section drawing-tools">
            <h3>Drawing Tools</h3>
            <button class="button" data-tool="selection">Selection</button>
            <button class="button" data-tool="pen">Pen</button>
            <button class="button" data-tool="brush">Brush</button>
            <button class="button" data-tool="text">Text</button>
            <button class="button" data-tool="shapes">Shapes</button>
            <button class="button" data-tool="eraser">Eraser</button>
        </div>
        
        <div class="tools-section perspective-tools">
            <h3>Perspective Tools</h3>
            <button class="button" data-perspective="grab">Grab/Pan</button>
            <button class="button" data-perspective="grid">Grid</button>
            <button class="button" data-perspective="zoom-in">Zoom In</button>
            <button class="button" data-perspective="zoom-out">Zoom Out</button>
            <button class="button" data-perspective="reset">Reset View</button>
        </div>
        
        <div class="status" id="status">
            Click tools above to test coordination...
        </div>
        
        <div class="status" id="canvas-status" style="background: #d4edda; margin-top: 10px;">
            Canvas: Drawing Events ENABLED
        </div>
    </div>
    
    <div class="test-container">
        <h2>Debug Commands</h2>
        <button class="button" onclick="debugToolState()">Debug Tool State</button>
        <button class="button" onclick="resetAllTools()">Reset All Tools</button>
        <button class="button" onclick="testCoordination()">Test Coordination</button>
        
        <div class="status" id="debug-output">
            Debug output will appear here...
        </div>
    </div>

    <script>
        // Mock implementations for testing without full coursebuilder setup
        let currentDrawingTool = 'selection';
        let currentPerspectiveTool = null;
        
        // Mock Canvas API
        const mockCanvasAPI = {
            setTool: function(tool) {
                console.log(`üé® MockCanvasAPI: Setting tool to ${tool}`);
                return true;
            },
            enableDrawingEvents: function() {
                console.log('‚úÖ MockCanvasAPI: Drawing events ENABLED');
                document.getElementById('canvas-status').style.background = '#d4edda';
                document.getElementById('canvas-status').textContent = 'Canvas: Drawing Events ENABLED';
            },
            disableDrawingEvents: function() {
                console.log('üö´ MockCanvasAPI: Drawing events DISABLED');
                document.getElementById('canvas-status').style.background = '#f8d7da';
                document.getElementById('canvas-status').textContent = 'Canvas: Drawing Events DISABLED';
            },
            areDrawingEventsEnabled: function() {
                const status = document.getElementById('canvas-status');
                return status.textContent.includes('ENABLED');
            }
        };
        
        // Mock Tool State Manager
        const mockToolStateManager = {
            setTool: function(tool) {
                console.log(`üé® MockToolStateManager: Setting tool to ${tool}`);
                currentDrawingTool = tool;
                updateStatus();
            },
            deactivateAllDrawingTools: function() {
                console.log('üîß MockToolStateManager: Deactivating all drawing tools');
                document.querySelectorAll('[data-tool]').forEach(btn => {
                    btn.classList.remove('active');
                });
                mockCanvasAPI.disableDrawingEvents();
                updateStatus();
            },
            getCurrentTool: function() {
                return currentDrawingTool;
            }
        };
        
        // Mock Perspective Manager
        const mockPerspectiveManager = {
            deactivateGrabTool: function() {
                console.log('üîß MockPerspectiveManager: Deactivating grab tool');
                document.querySelectorAll('[data-perspective]').forEach(btn => {
                    btn.classList.remove('active', 'perspective__item--active');
                });
                if (currentPerspectiveTool === 'grab') {
                    currentPerspectiveTool = null;
                }
                
                // Reactivate drawing tools when grab is deactivated
                mockCanvasAPI.enableDrawingEvents();
                const currentTool = mockToolStateManager.getCurrentTool();
                const toolButton = document.querySelector(`[data-tool="${currentTool}"]`);
                if (toolButton) {
                    toolButton.classList.add('active');
                }
                
                updateStatus();
            }
        };
        
        // Expose mock managers globally
        window.toolStateManager = mockToolStateManager;
        window.perspectiveManager = mockPerspectiveManager;
        window.canvasAPI = mockCanvasAPI;
        
        // Simple ToolCoordinator implementation for testing
        class TestToolCoordinator {
            constructor() {
                this.activeToolType = 'drawing';
                this.activeDrawingTool = 'selection';
                this.activePerspectiveTool = null;
            }
            
            setDrawingTool(tool) {
                console.log(`üéØ ToolCoordinator: Setting drawing tool to "${tool}"`);
                if (this.activeToolType === 'perspective') {
                    this.deactivatePerspectiveTools();
                }
                this.activeToolType = 'drawing';
                this.activeDrawingTool = tool;
                this.activePerspectiveTool = null;
                updateStatus();
            }
            
            setPerspectiveTool(tool) {
                console.log(`üéØ ToolCoordinator: Setting perspective tool to "${tool}"`);
                if (this.activeToolType === 'drawing') {
                    this.deactivateDrawingTools();
                }
                this.activeToolType = 'perspective';
                this.activePerspectiveTool = tool;
                this.activeDrawingTool = null;
                updateStatus();
            }
            
            deactivateDrawingTools() {
                mockToolStateManager.deactivateAllDrawingTools();
            }
            
            deactivatePerspectiveTools() {
                mockPerspectiveManager.deactivateGrabTool();
            }
            
            getActiveToolInfo() {
                return {
                    type: this.activeToolType,
                    drawingTool: this.activeDrawingTool,
                    perspectiveTool: this.activePerspectiveTool
                };
            }
            
            debugState() {
                const info = this.getActiveToolInfo();
                console.log('üîç ToolCoordinator State:', info);
                document.getElementById('debug-output').innerHTML = 
                    `<strong>Coordinator State:</strong><br>
                    Type: ${info.type}<br>
                    Drawing Tool: ${info.drawingTool}<br>
                    Perspective Tool: ${info.perspectiveTool}<br>
                    Canvas Events: ${mockCanvasAPI.areDrawingEventsEnabled() ? 'ENABLED' : 'DISABLED'}`;
                return info;
            }
            
            resetAllTools() {
                console.log('üîÑ ToolCoordinator: Resetting all tools');
                this.deactivateDrawingTools();
                this.deactivatePerspectiveTools();
                this.activeToolType = 'drawing';
                this.activeDrawingTool = 'selection';
                this.activePerspectiveTool = null;
                
                // Activate selection visually and re-enable canvas
                mockCanvasAPI.enableDrawingEvents();
                const selectionBtn = document.querySelector('[data-tool="selection"]');
                if (selectionBtn) {
                    selectionBtn.classList.add('active');
                }
                updateStatus();
            }
        }
        
        // Initialize coordinator
        const toolCoordinator = new TestToolCoordinator();
        window.toolCoordinator = toolCoordinator;
        
        // Event handlers
        document.addEventListener('click', function(e) {
            if (e.target.hasAttribute('data-tool')) {
                // Drawing tool clicked
                const tool = e.target.getAttribute('data-tool');
                
                // Visual feedback
                document.querySelectorAll('[data-tool]').forEach(btn => {
                    btn.classList.remove('active');
                });
                e.target.classList.add('active');
                
                // Notify coordinator and tool manager
                toolCoordinator.setDrawingTool(tool);
                mockToolStateManager.setTool(tool);
                
            } else if (e.target.hasAttribute('data-perspective')) {
                // Perspective tool clicked
                const tool = e.target.getAttribute('data-perspective');
                
                if (tool === 'grab') {
                    // Toggle grab tool
                    const isActive = e.target.classList.contains('active');
                    document.querySelectorAll('[data-perspective]').forEach(btn => {
                        btn.classList.remove('active', 'perspective__item--active');
                    });
                    
                    if (!isActive) {
                        e.target.classList.add('active', 'perspective__item--active');
                        toolCoordinator.setPerspectiveTool('grab');
                        currentPerspectiveTool = 'grab';
                    } else {
                        currentPerspectiveTool = null;
                        // When deactivating grab, reset to drawing mode
                        toolCoordinator.activeToolType = 'drawing';
                        mockCanvasAPI.enableDrawingEvents();
                        const selectionBtn = document.querySelector('[data-tool="selection"]');
                        if (selectionBtn) {
                            selectionBtn.classList.add('active');
                        }
                    }
                } else {
                    // Other perspective tools (non-exclusive)
                    e.target.classList.toggle('active');
                }
                
                updateStatus();
            }
        });
        
        function updateStatus() {
            const info = toolCoordinator.getActiveToolInfo();
            const canvasEnabled = mockCanvasAPI.areDrawingEventsEnabled();
            document.getElementById('status').innerHTML = 
                `<strong>Current State:</strong><br>
                Tool Type: <strong>${info.type || 'None'}</strong><br>
                Drawing Tool: <strong>${info.drawingTool || 'None'}</strong><br>
                Perspective Tool: <strong>${info.perspectiveTool || 'None'}</strong><br>
                Canvas Events: <strong style="color: ${canvasEnabled ? 'green' : 'red'}">${canvasEnabled ? 'ENABLED' : 'DISABLED'}</strong>`;
        }
        
        function debugToolState() {
            toolCoordinator.debugState();
        }
        
        function resetAllTools() {
            toolCoordinator.resetAllTools();
        }
        
        function testCoordination() {
            console.log('üß™ Running coordination test...');
            
            // Test sequence
            setTimeout(() => {
                console.log('1. Setting pen tool...');
                document.querySelector('[data-tool="pen"]').click();
            }, 500);
            
            setTimeout(() => {
                console.log('2. Setting grab tool...');
                document.querySelector('[data-perspective="grab"]').click();
            }, 1500);
            
            setTimeout(() => {
                console.log('3. Setting brush tool...');
                document.querySelector('[data-tool="brush"]').click();
            }, 2500);
            
            setTimeout(() => {
                console.log('4. Test complete!');
                debugToolState();
            }, 3500);
        }
        
        // Initialize with selection tool active
        window.addEventListener('load', function() {
            const selectionBtn = document.querySelector('[data-tool="selection"]');
            if (selectionBtn) {
                selectionBtn.classList.add('active');
            }
            updateStatus();
        });
    </script>
</body>
</html>
