<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Color Functionality</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
</head>
<body>
    <h1>Color Selection Test</h1>
    
    <div>
        <h2>Pen Colors</h2>
        <label for="pen-stroke-select">Pen Stroke:</label>
        <select id="pen-stroke-select" class="input input--color" data-color-selector="pen-stroke">
            <option value="#1a1a1a" data-color="#1a1a1a" selected>Black</option>
            <option value="#4a7c59" data-color="#4a7c59">Green</option>
            <option value="#4a79a4" data-color="#4a79a4">Blue</option>
            <option value="#a74a4a" data-color="#a74a4a">Red</option>
        </select>
        
        <br><br>
        
        <label for="pen-fill-select">Pen Fill:</label>
        <select id="pen-fill-select" class="input input--color" data-color-selector="pen-fill">
            <option value="#1a1a1a" data-color="#1a1a1a">Black</option>
            <option value="#4a7c59" data-color="#4a7c59">Green</option>
            <option value="#4a79a4" data-color="#4a79a4">Blue</option>
            <option value="#f8fafc" data-color="#f8fafc" selected>White</option>
        </select>
    </div>
    
    <div style="margin-top: 20px;">
        <h3>Test Results:</h3>
        <div id="results"></div>
    </div>
    
    <script>
        // Simple test to verify color changes work
        function logResult(message) {
            const results = document.getElementById('results');
            results.innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }
        
        // Mock UIEventHandler 
        window.uiEventHandler = {
            handleColorChange: function(colorSelector, colorHex) {
                logResult(`‚úÖ handleColorChange called: ${colorSelector} -> ${colorHex}`);
                
                // Test localStorage save/restore
                const key = `color-${colorSelector}`;
                localStorage.setItem(key, colorHex);
                logResult(`üíæ Saved to localStorage: ${key} = ${colorHex}`);
            }
        };
        
        $(document).ready(function() {
            logResult('üü¢ jQuery loaded, initializing Select2...');
            
            // Initialize Select2 color dropdowns
            $('#pen-stroke-select, #pen-fill-select').select2({
                templateResult: function(state) {
                    if (!state.id) { return state.text; }
                    
                    var colorValue = $(state.element).data('color');
                    if (!colorValue) { return state.text; }
                    
                    var $state = $('<span><div style="width: 16px; height: 16px; background-color: ' + colorValue + '; border: 1px solid #ccc; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>' + state.text + '</span>');
                    return $state;
                },
                templateSelection: function(state) {
                    if (!state.id) { return state.text; }
                    
                    var colorValue = $(state.element).data('color');
                    if (!colorValue) { return state.text; }
                    
                    var $state = $('<span><div style="width: 16px; height: 16px; background-color: ' + colorValue + '; border: 1px solid #ccc; border-radius: 2px; display: inline-block;"></div></span>');
                    return $state;
                },
                minimumResultsForSearch: -1,
                width: '300px'
            });
            
            logResult('üé® Select2 initialized');
            
            // Bind color change events
            $('#pen-stroke-select, #pen-fill-select').on('select2:select', function (e) {
                var data = e.params.data;
                var colorSelector = $(this).data('color-selector');
                
                logResult(`üìù Select2 event triggered: ${colorSelector} -> ${data.id}`);
                
                // Call the handler
                if (window.uiEventHandler && window.uiEventHandler.handleColorChange) {
                    window.uiEventHandler.handleColorChange(colorSelector, data.id);
                } else {
                    logResult('‚ùå uiEventHandler.handleColorChange not found');
                }
            });
            
            logResult('üéØ Event handlers bound');
            
            // Test restored values
            const strokeSaved = localStorage.getItem('color-pen-stroke');
            const fillSaved = localStorage.getItem('color-pen-fill');
            
            if (strokeSaved) {
                $('#pen-stroke-select').val(strokeSaved).trigger('change');
                logResult(`üîÑ Restored pen stroke: ${strokeSaved}`);
            }
            
            if (fillSaved) {
                $('#pen-fill-select').val(fillSaved).trigger('change');
                logResult(`üîÑ Restored pen fill: ${fillSaved}`);
            }
            
            logResult('‚úÖ Test setup complete - try changing colors above');
        });
    </script>
</body>
</html>
